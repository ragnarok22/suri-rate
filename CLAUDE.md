# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SuriRate is a Next.js 15 PWA that compares USD and EUR exchange rates from major Surinamese banks. It scrapes rates from 6 banks (Finabank, Central Bank, CME, Hakrinbank, DSB, Republic Bank), caches them using Next.js revalidation, and displays them in a comparative interface with offline support.

## Development Commands

- `pnpm install` - Install dependencies
- `pnpm dev` - Start development server with Turbopack
- `pnpm build` - Build for production
- `pnpm start` - Start production server
- `pnpm test` - Run Vitest test suite in watch mode
- `pnpm test --run` - Run tests once (non-watch mode)
- `pnpm lint` - Run ESLint
- `pnpm format` - Format code with Prettier

## Architecture

### Key Directories

- `app/` - Next.js App Router structure (layout, pages, routing)
- `utils/` - Core business logic and bank scrapers
- `components/` - React components (UI components in `ui/` subdirectory)
- `public/` - Static assets and PWA files

### Data Flow

1. **Rate Collection**: Bank scrapers in `utils/places/providers.ts` fetch exchange rates using custom fetch wrapper (`utils/index.ts`)
2. **Caching**: Rates cached using Next.js 12-hour revalidation and service worker caching
3. **Display**: Main page compares rates, highlights best rates using `findBestRates()` helper

### Bank Scrapers

Each bank has a dedicated scraper function in `utils/places/providers.ts`:

- **Finabank**: HTML scraping with regex patterns
- **DSB**: JSON API endpoint
- **CBVS**: Table scraping from HTML (has graceful fallback returning zeros on error)
- **CME**: Direct axios POST request with comprehensive browser headers to bypass Cloudflare bot detection (critical: requires full browser fingerprint including User-Agent, Sec-Ch-Ua, Sec-Fetch headers, Origin, and Referer to work on Vercel)
- **Hakrinbank**: Table parsing from exchange page
- **Republic Bank**: Table scraping with specific column mapping

The `getCurrentRates()` function in `utils/places/index.ts` orchestrates all scrapers sequentially, returning zeros for failed banks to ensure the app always displays data.

### Type System

Core types in `utils/definitions.ts`:

- `BankName` - Union type of all supported banks
- `Currency` - "USD" | "EUR"
- `ExchangeRate` - Currency with buy/sell rates
- `BankRates` - Bank info + exchange rates array

### HTTP Request Handling

Two approaches used depending on requirements:

1. **Custom fetch wrapper** (`utils/index.ts`):
   - 12-hour revalidation via Next.js `next.revalidate`
   - Stream reading for response body handling
   - Used by most bank scrapers (Finabank, DSB, CBVS, Hakrinbank, Republic Bank)

2. **Direct axios** (CME scraper only):
   - Required for CME to bypass Cloudflare protection
   - Uses comprehensive browser headers for bot detection evasion
   - Cannot use fetch wrapper due to Cloudflare's advanced fingerprinting

## Environment Variables

### Vercel Deployment (Required)

```bash
ENABLE_EXPERIMENTAL_COREPACK=1  # Required for pnpm on Vercel
```

### Analytics (Optional)

```bash
NEXT_PUBLIC_POSTHOG_KEY=phc_xxxxx           # PostHog analytics key
NEXT_PUBLIC_POSTHOG_HOST=https://us.i.posthog.com  # PostHog API endpoint
```

**Note**: Cache duration is hardcoded to 12 hours in `utils/index.ts:3`. PostHog analytics are optional and only used in `app/providers.tsx`.

## Testing

- Uses Vitest with Node.js environment
- Path alias `@` maps to project root
- Tests mock both the custom `api()` wrapper and axios for comprehensive coverage
- CI runs on GitHub Actions with Node 20 and pnpm
- Important: CME tests require mocking `axios.post` with `vi.spyOn()`

## Deployment

- Configured for Vercel deployment
- PWA via hand-crafted service worker (`public/sw.js`) registered in `components/pwa-prompts.tsx` (production only)
- Web app manifest generated by `app/manifest.ts` (served at `/manifest.webmanifest`)
- Next.js caching with 12-hour revalidation
- Service worker caching for offline support

## Key Implementation Notes

- Main page uses `force-dynamic` to ensure fresh data on each request
- Bank scrapers handle various data formats (HTML tables, JSON APIs, regex parsing)
- Error handling includes graceful fallbacks (zeros) for unreliable bank websites to ensure app always displays
- PWA includes offline fallback (`public/offline.html`) served by the service worker
- PostHog analytics integration via providers pattern

### Critical: CME Cloudflare Bypass

The CME scraper **must** include comprehensive browser headers to bypass Cloudflare bot detection on Vercel:

- User-Agent (modern Chrome version)
- Sec-Ch-Ua, Sec-Ch-Ua-Mobile, Sec-Ch-Ua-Platform
- Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site
- Origin, Referer (pointing to cme.sr)
- Accept-Encoding, Connection, Host

If CME returns 403 with "Just a moment..." HTML, it means Cloudflare is blocking the request. Verify all headers are present and match a real browser fingerprint.
